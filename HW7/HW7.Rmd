---
title: "HW7"
author: "Jiaheng Cai"
date: "11/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(KMsurv)
library(survival)
library(gtsummary)
library(survMisc)
library(dplyr)
library(tidyverse)
```

## 8.12
```{r}
data(std)
std$iinfct = as.factor(std$iinfct)
std$condom = as.factor(std$condom)
fit.std = coxph(Surv(time, rinfct) ~ ., data = std, ties = 'breslow')
summary(fit.std)
step(fit.std)
fit.std.f = coxph(Surv(time, rinfct) ~ yschool + iinfct + os30d + abdpain + 
                    condom + vagina + dchexam, data = std, ties = 'breslow')
summary(fit.std.f)
```

## 9.3
### a
```{r}
data(gastric)
fit.gas = coxph(Surv(time, event) ~ ., data = gastric, ties = 'breslow')
summary(fit.gas)
confint(fit.gas)
exp(confint(fit.gas))
```

### b
```{r}
gastric$tg = gastric$group*log(gastric$time)
fit.gast = coxph(Surv(time, event) ~ group + tg, data = gastric, ties = 'breslow')
summary(fit.gast)
```
tg /= 0 means nonproportional hazards

### c
```{r}
event.times <- sort(unique(gastric$time[gastric$event == 1]))

loglik <- as.numeric(length(event.times))

for(i in 1:length(event.times)){
  gastric$z1t <- ifelse(gastric$time <= event.times[i] & gastric$group == 0, 1, 0)
  gastric$z2t <- ifelse(gastric$time > event.times[i] & gastric$group == 0, 1, 0)

  fit <- coxph(Surv(time, event) ~  z1t +z2t, data = gastric, ties = 'breslow')
  loglik[i] <- fit$loglik[2]
}

cbind(event.times, loglik)
opt_tau <- event.times[which.max(loglik)]
opt_tau
```

```{r}
gastric$z1t=ifelse(gastric$time <= 460 & gastric$group == 0, 1, 0)
gastric$z2t=ifelse(gastric$time > 460 & gastric$group == 0, 1, 0)
fit.gastric.f=coxph(Surv(time, event) ~ z1t +z2t, data = gastric, ties = 'breslow')
summary(fit.gastric.f)
```
After 460 days, don't do chemotherapy only.

## 9.5
### a

```{r}
data(larynx)
larynx$sefi <- ifelse(larynx$diagyr < 75, 0, 1) 

fit.l.s <- coxph(Surv(time, delta) ~ stage + age + strata(sefi), data = larynx, ties = 'breslow')
fit.l = coxph(Surv(time, delta) ~ stage + age, data = larynx, ties = 'breslow')

larynx74 <- larynx[larynx$diagyr < 75, ] 
larynx76 <- larynx[larynx$diagyr >= 75, ]

fit0 <- coxph(Surv(time, delta) ~ stage + age, data = larynx74, ties = 'breslow')
fit1 <- coxph(Surv(time, delta) ~ stage + age, data = larynx76, ties = 'breslow')

summary(fit.l.s)
summary(fit.l)

anova(fit.l.s)
anova(fit.l)

```

### b
```{r}
X2 <- -2*(fit.l.s$loglik[2] - (fit0$loglik[2] + fit1$loglik[2])); X2
1 - pchisq(X2, 2) 
```

### c ???
```{r}
W <- (fit1$coefficients[2] - fit0$coefficients[2])^2 / (fit1$var[2,2] + fit0$var[2,2])
1 - pchisq(W, 1) #p-value ## Z1

W <- (fit1$coefficients[1] - fit0$coefficients[1])^2 / (fit1$var[1,1] + fit0$var[1,1])
1 - pchisq(W, 1) #p-value ## Z1
```

## 9.8
### a
```{r}
data(burn)
burn$teti = burn$T1*log(burn$T3)
fit.burn = coxph(Surv(T3, D3) ~ teti, data = burn, ties = 'breslow')
summary(fit.burn)
```

### b
```{r}
burn$tpti = burn$T2*log(burn$T3)
fit.burn.p = coxph(Surv(T3, D3) ~ tpti, data = burn, ties = 'breslow')
summary(fit.burn.p)
```

### c
```{r}
fit.burn.f = coxph(Surv(T3, D3) ~ Z1+Z2+Z3+Z4+Z5+Z6+Z7+Z8+Z9+Z10+Z11+T1+teti+T2+tpti, data = burn, ties = 'breslow')
summary(fit.burn.f)
```

## 11.1c
```{r}
data(larynx)
fit <- coxph(Surv(time,delta) ~ as.factor(stage)+age, data = larynx, 
                method = 'breslow')

mg.residual <- resid(fit, type = "martingale")
cs.residual <- larynx$delta - mg.residual

fit.cs <- survfit(Surv(cs.residual, larynx$delta) ~ 1) 
H.cs   <- cumsum(fit.cs$n.event/fit.cs$n.risk)
plot(fit.cs$time, H.cs, type='s', col='blue', 
     main = 'Cox-Snell Residual Plot \n MTX as Fixed-Time Covariate', 
     xlab = 'Residual', ylab = 'Nelson-Aalen Cum. Hazard') 
abline(0, 1, col='red',  lty = 2)
```

## 11.3
### (a)
```{r}
data(larynx)
fit3 = basehaz(coxph(Surv(time,delta)~strata(as.factor(stage))+age, data = larynx, ties = 'breslow'))

plot(log(fit3$hazard[fit3$strata == 1])~ fit3$time[fit3$strata == 1], type = 's',
     ylab = 'Log Cumulative Hazard', xlab = 'Time', main = 'Log H(t) vs. Time',
     col = 'blue', lty = 1, xlim = c(0, 10), ylim = c(-4, 1))
lines(log(fit3$hazard[fit3$strata == 2]) ~  fit3$time[fit3$strata == 2],
      col = 'red', lty = 2, type = 's')
lines(log(fit3$hazard[fit3$strata == 3]) ~  fit3$time[fit3$strata == 3],
      col = 'yellow', lty = 2, type = 's')
lines(log(fit3$hazard[fit3$strata == 4]) ~  fit3$time[fit3$strata == 4],
      col = 'green', lty = 2, type = 's')
legend('bottomright', c('stage 1', 'stage 2', 'stage 3', 'stage 4'),col = c('blue', 'red', 'yellow', 'green'), lty = c(1, 4),
       bty = 'n')
```

### b
```{r}
  H1 = fit3$hazard[fit3$strata == 1]
  t1 = fit3$time[fit3$strata == 1]
  H2 = fit3$hazard[fit3$strata == 2]
  t2 = fit3$time[fit3$strata == 2]
  H3 = fit3$hazard[fit3$strata == 3]
  t3 = fit3$time[fit3$strata == 3]
  H4 = fit3$hazard[fit3$strata == 4]
  t4 = fit3$time[fit3$strata == 4]


plot((log(H2)-log(H1[1:15]))~ t2, type = 's',
     ylab = 'Log Cumulative Hazard', xlab = 'Time', main = 'Log H(t) vs. Time',
     col = 'blue', lty = 1, xlim = c(0, 10), ylim = c(-3, 3))
lines((log(H3)-log(H1[1:23])) ~  t3,
      col = 'brown', lty = 3, type = 's')
lines((log(H4)-log(H1[1:12])) ~  t4,
      col = 'brown', lty = 4, type = 's')
legend('bottomright', c('stage 2-stage 1', 'stage 3-stage 1', 'stage 4-stage 1'),
       col = c('blue', 'red', 'brown'), lty = c(1:3),
       bty = 'n')
```


### c
```{r}
reptime <- function(l, t){
  x <- numeric(max(t))
  for(i in min(t):max(t)){
    diff <- i - t
    diff <- diff[diff >= 0]
    x[i] <- l[which.min(diff)]
  }
  return(x)
}

H1 <- fit3$hazard[fit3$strata == 1]
H2 <- fit3$hazard[fit3$strata == 2]
H3 <- fit3$hazard[fit3$strata == 3]
H4 <- fit3$hazard[fit3$strata == 4]

t1 <- fit3$time[fit3$strata == 1]
t2 <- fit3$time[fit3$strata == 2]
t3 <- fit3$time[fit3$strata == 3]
t4 <- fit3$time[fit3$strata == 4]


H1 <- reptime(H1, t1)
H2 <- reptime(H2, t2)
H3 <- reptime(H3, t3)
H4 <- reptime(H4, t4)

plot(H2[1:9] ~ H1[1:9], type = 's',
     ylab = 'Log Hazard', xlab = 'Stage 1', main = 'Anderson Plot',
     col = 'blue', lty = 1, xlim = c(0, 1), ylim = c(0, 1))
lines(H3[1:9] ~ H1[1:9],
      col = 'red', lty = 2, type = 's')
lines(H4[1:4] ~ H1[1:4],
      col = 'green', lty = 3, type = 's')
legend('bottomright', c('stage 2', 'stage 3', 'stage 4'),
       col = c('blue', 'red', 'green'), lty = c(1:3),
       bty = 'n')
abline(0, 1, col='black',  lty=3)
```








