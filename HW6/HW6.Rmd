---
title: "HW6"
author: "Jiaheng Cai"
date: "11/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(KMsurv)
library(survival)
```

# 8.4

## (a)

```{r}
data(bnct)
bnct$z1 = ifelse(bnct$trt == 2, 1, 0)
bnct$z2 = ifelse(bnct$trt == 3, 1, 0)
fit.breslow = coxph(Surv(time, death) ~ z1 + z2, data = bnct, ties = "breslow")
fit.breslow
exp(confint(fit.breslow))
```
RR is 0.1633, CI is (0.0545, 0.4892)

## (b)
Overall idea
```{r}
summary(fit.breslow)
```
Score test
```{r}
round(cbind(fit.breslow$score, 1 - pchisq(fit.breslow$score, 2)), 4)
```

Likelihood test
```{r}
round(cbind(2*(fit.breslow$loglik[2]-fit.breslow$loglik[1]), 
            1-pchisq(2*(fit.breslow$loglik[2]-fit.breslow$loglik[1]), 2)), 4)
```

Wald test
```{r}
b.null <- c(0, 0)
X2.wald <- t(fit.breslow$coefficients[1:2] - b.null) %*% 
  solve(fit.breslow$var[-4, -4]) %*% 
  (fit.breslow$coefficients[1:2] - b.null)
round(cbind(X2.wald, 1-pchisq(X2.wald, 2)), 4)
```

## (c)
```{r}
C  <- c(1, -1)
b0 <- c(0, 0)
b  <- fit.breslow$coefficients
V  <- fit.breslow$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 2)), 4)
```

## (d)
```{r}
c(rr = exp(fit.breslow$coef %*% c(-1,1)), CI=exp(2*(fit.breslow$coef %*%
c(-1,1) + c(-1,1)*1.96*sqrt(c(-1,1) %*% fit.breslow$var %*% c(-1,1)))))
```

## (e)(f)
```{r}
fit.breslow1 = coxph(Surv(time, death) ~ z1, data = bnct, ties = "breslow")
summary(fit.breslow1)
fit.breslow2 = coxph(Surv(time, death) ~ z2, data = bnct, ties = "breslow")
summary(fit.breslow2)
```

LL
```{r}
round(cbind(2*(fit.breslow1$loglik[2]-fit.breslow1$loglik[1]), 
            1-pchisq(2*(fit.breslow1$loglik[2]-fit.breslow1$loglik[1]), 1)), 4)
round(cbind(2*(fit.breslow2$loglik[2]-fit.breslow2$loglik[1]), 
            1-pchisq(2*(fit.breslow2$loglik[2]-fit.breslow2$loglik[1]), 1)), 4)
```

Wald
```{r}
C  <- c(1)
b0 <- c(0)
b  <- fit.breslow1$coefficients
V  <- fit.breslow1$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 1)), 4)

C  <- c(1)
b0 <- c(0)
b  <- fit.breslow2$coefficients
V  <- fit.breslow2$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 1)), 4)
```

# 8.5
## (a)
c2 = NHL Auto
c3 = HOD Allo
c4 = HOD Auto

```{r}
data(hodg)
hodg$c2 = rep(0,nrow(hodg))
hodg$c3 = rep(0,nrow(hodg))
hodg$c4 = rep(0,nrow(hodg))
hodg$c2[hodg$dtype == 1 & hodg$gtype == 2] = 1
hodg$c3[hodg$dtype == 2 & hodg$gtype == 1] = 1
hodg$c4[hodg$dtype == 2 & hodg$gtype == 2] = 1
```

gtypeb:
allo = 0
auto = 1

dtypeb:
NHL = 0
HOD = 1

int = gtypeb* dtypeb
```{r}
hodg$gtypeb = ifelse(hodg$gtype == 1,0,1)
hodg$dtypeb = ifelse(hodg$dtype == 1,0,1)
hodg$int = hodg$gtypeb* hodg$dtypeb
```

```{r}
fit.hodg = coxph(Surv(time, delta) ~ c2 + c3 + c4, data = hodg, ties = "breslow")
summary(fit.hodg)
anova(fit.hodg)
```

## (b)
```{r}
fit.hodgb = coxph(Surv(time, delta) ~ gtypeb + dtypeb + int, data = hodg, ties = "breslow")
summary(fit.hodgb)
anova(fit.hodgb)
```

Wald
```{r}
C  <- c(0,0,1)
b0 <- c(0, 0,0)
b  <- fit.hodgb$coefficients
V  <- fit.hodgb$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 1)), 4)
```

## (c)
```{r}
summary(fit.hodg)
```
c2 (NHL auto)    est=1.942    ci=(0.6427, 5.870)

## (d)
Allo group
```{r}
C  <- c(0,1,0)
b0 <- c(0, 0,0)
b  <- fit.hodg$coefficients
V  <- fit.hodg$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 1)), 4)
```

auto group
```{r}
C  <- c(1,0,-1)
b0 <- c(0, 0,0)
b  <- fit.hodg$coefficients
V  <- fit.hodg$var
wald = t(C %*% b - C %*% b0) %*% solve(t(C) %*% V %*% C) %*% 
  (C %*% b - C %*% b0)
round(cbind(wald, 1-pchisq(wald, 1)), 4) #1 or 2 df?
```

## (e)

# 8.10
## (a)
```{r}
data(bmt)
fit.bmt = coxph(Surv(ta, da) ~ z10, data = bmt, ties = "breslow")
summary(fit.bmt)
```

## (b) ???
```{r}
fit.group  <- coxph(Surv(ta, da) ~ group, data = bmt, ties = 'breslow')
group.coef <- fit.group$coefficients
```

```{r}
X2.lrt <- 2 * (fit.bmt$loglik[2] - fit.group$loglik[2])
round(cbind(X2.lrt, 1-pchisq(X2.lrt, 1)), 4)


b.null <- c(0)
X2.wald <- t(fit.bmt$coefficients[1] - b.null) %*% 
  solve(fit.bmt$var[-4, -4]) %*% 
  (fit.bmt$coefficients[1] - b.null)
round(cbind(X2.wald, 1-pchisq(X2.wald, 1)), 4)

fit.bmtG = coxph(Surv(ta, da) ~ z10 + group, data = bmt, ties = "breslow")
summary(fit.bmtG)
```

## (c)
```{r}
bmt$ind = bmt$group * bmt$z10
fit.bmtI = coxph(Surv(ta, da) ~ z10 + group+ind, data = bmt, ties = "breslow")
summary(fit.bmtI)
```

## (d)
```{r}
fit.bmtd = coxph(Surv(ta, da) ~ z1 + z3+z5+z8+z7+I(group==2)+I(group++3)+z10, data = bmt, ties = "breslow")
summary(fit.bmtd)

rr = exp(fit.bmtd$coef[8])

exp(-0.6230812-1.96*0.5015323)
exp(-0.6230812+1.96*0.5015323)
```

# 8.14
## (a)
```{r}
group1 = bmt[bmt$group == 1,]
group2 = bmt[bmt$group == 2,]
group3 = bmt[bmt$group == 3,]

fit.groupz101  <- coxph(Surv(ta, da) ~ z10, data = group1, ties = 'breslow')
fit.groupz102  <- coxph(Surv(ta, da) ~ z10, data = group2, ties = 'breslow')
fit.groupz103  <- coxph(Surv(ta, da) ~ z10, data = group3, ties = 'breslow')

b.haz <- basehaz(fit.groupz101, centered = F)
t     <- b.haz[ ,2]
S.est <- cbind(exp(-b.haz[,1]), t)
S.est

b.haz2 <- basehaz(fit.groupz102, centered = F)
t2     <- b.haz2[ ,2]
S.est2 <- cbind(exp(-b.haz2[,1]), t2)
S.est2

b.haz3 <- basehaz(fit.groupz103, centered = F)
t3     <- b.haz3[ ,2]
S.est3 <- cbind(exp(-b.haz3[,1]), t3)
S.est3
```

## (b)
```{r}
fit.trtgroup <- coxph(Surv(ta, da) ~ group+z10, data = bmt, ties = 'breslow')
fit.s1 <- survfit(fit.trtgroup, newdata = data.frame(group = 3, z10 = 1), 
                  se.fit = TRUE, conf.int = .95, conf.type = 'log-log')

summary(fit.s1)
```


